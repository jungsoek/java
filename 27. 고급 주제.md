# 27. ê³ ê¸‰ ì£¼ì œ

## í´ë˜ìŠ¤ ë¡œë” êµ¬ì¡°

### 1. í´ë˜ìŠ¤ ë¡œë”ë€?

**í´ë˜ìŠ¤ ë¡œë”(ClassLoader)** ëŠ” `.class` íŒŒì¼ì„ ì½ì–´ë“¤ì—¬ ë©”ëª¨ë¦¬ì— **í´ë˜ìŠ¤ ê°ì²´(Class<?> ê°ì²´)** ë¡œ ë¡œë”©í•˜ëŠ” JVM êµ¬ì„± ìš”ì†Œë‹¤.
 JVMì€ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì¤‘ì— **í•„ìš”í•œ í´ë˜ìŠ¤ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë”©**í•˜ë©°, ì´ ê³¼ì •ì„ **í´ë˜ìŠ¤ ë¡œë”©(Class Loading)**ì´ë¼ê³  í•œë‹¤.

------

### 2. í´ë˜ìŠ¤ ë¡œë”© ê³¼ì •

í´ë˜ìŠ¤ ë¡œë”©ì€ í¬ê²Œ ë‹¤ìŒ 5ë‹¨ê³„ë¡œ êµ¬ì„±ëœë‹¤:

1. **ë¡œë”©(Loading)**
    `.class` íŒŒì¼ì„ ë°”ì´ë„ˆë¦¬ë¡œ ì½ì–´ ë©”ëª¨ë¦¬ì— ë¡œë“œ
2. **ë§í¬(Linking)**
   - **ê²€ì¦(Verification)**: ìœ íš¨í•œ í´ë˜ìŠ¤ì¸ì§€ ê²€ì‚¬
   - **ì¤€ë¹„(Preparation)**: static í•„ë“œ ë©”ëª¨ë¦¬ í• ë‹¹ ë° ê¸°ë³¸ê°’ ì„¤ì •
   - **í•´ê²°(Resolution)**: ì°¸ì¡°ëœ í´ë˜ìŠ¤ë“¤ì„ ë¡œë”©
3. **ì´ˆê¸°í™”(Initialization)**
    static ë¸”ë¡ê³¼ static í•„ë“œì— ê°’ í• ë‹¹
4. **ì‚¬ìš©(Using)**
    ì¸ìŠ¤í„´ìŠ¤ ìƒì„±, ë©”ì„œë“œ í˜¸ì¶œ ë“±
5. **ì–¸ë¡œë”©(Unloading)**
    ì°¸ì¡°ë˜ì§€ ì•ŠëŠ” í´ë˜ìŠ¤ëŠ” GCì— ì˜í•´ ì œê±° (ì£¼ë¡œ ì‚¬ìš©ì ì •ì˜ ë¡œë”ì—ì„œë§Œ)

------

### 3. JVMì˜ ê¸°ë³¸ í´ë˜ìŠ¤ ë¡œë” ê³„ì¸µ êµ¬ì¡°

JVMì—ëŠ” **ë¶€íŠ¸ìŠ¤íŠ¸ë© â†’ í™•ì¥ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ ì‚¬ìš©ì ì •ì˜ ë¡œë”**ë¡œ ì´ì–´ì§€ëŠ” **íŠ¸ë¦¬ êµ¬ì¡°**ê°€ ì¡´ì¬í•œë‹¤.

```
[ Bootstrap ClassLoader ] (C/C++ë¡œ êµ¬í˜„ëœ JVM ë‚´ë¶€)
         â†“
[ Platform ClassLoader (JDK 9+) / Extension ClassLoader (JDK 8 ì´í•˜) ]
         â†“
[ Application ClassLoader ]
         â†“
[ Custom ClassLoader (ì§ì ‘ êµ¬í˜„) ]
```

------

#### ğŸ”¸ 3.1 Bootstrap ClassLoader

- **ê°€ì¥ ìµœìƒìœ„ í´ë˜ìŠ¤ ë¡œë”**
- **JVM ë‚´ë¶€(C ì½”ë“œ)**ì— êµ¬í˜„ë˜ì–´ ìˆìŒ (Javaë¡œ ì ‘ê·¼ ë¶ˆê°€)
- `JAVA_HOME/lib`ì— ìˆëŠ” `rt.jar`, `java.base` ëª¨ë“ˆ ë“± **í•µì‹¬ í´ë˜ìŠ¤**ë¥¼ ë¡œë”©
- ì˜ˆ: `java.lang.String`, `java.util.*`

------

#### ğŸ”¸ 3.2 Platform or Extension ClassLoader

- **JDK 9+: `PlatformClassLoader`**
- **JDK 8 ì´í•˜: `ExtClassLoader`**
- `JAVA_HOME/lib/ext` ë˜ëŠ” ëª¨ë“ˆ ì‹œìŠ¤í…œ ê¸°ë°˜ í´ë˜ìŠ¤ ë¡œë”© ìˆ˜í–‰

------

#### ğŸ”¸ 3.3 Application ClassLoader

- í´ë˜ìŠ¤íŒ¨ìŠ¤ì— í¬í•¨ëœ `.jar`, `.class` íŒŒì¼ì„ ë¡œë”©
- ë³´í†µ ìš°ë¦¬ê°€ ì‘ì„±í•œ **ì¼ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤**ë¥¼ ë¡œë”©
- `ClassLoader.getSystemClassLoader()`ë¡œ ì ‘ê·¼ ê°€ëŠ¥

------

#### ğŸ”¸ 3.4 ì‚¬ìš©ì ì •ì˜ í´ë˜ìŠ¤ ë¡œë”

- `ClassLoader`ë¥¼ ìƒì†í•´ ì§ì ‘ êµ¬í˜„
- ë³´ì•ˆ, í´ë˜ìŠ¤ ê²©ë¦¬, ë¦¬í”Œë ‰ì…˜ ê¸°ë°˜ í”„ë ˆì„ì›Œí¬ ë“±ì—ì„œ í™œìš©ë¨
- ì˜ˆ: Spring, Tomcat, OSGi ë“±ì€ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ë¡œë” ì‚¬ìš©

------

### 4. í´ë˜ìŠ¤ ë¡œë”ì˜ ìœ„ì„ ëª¨ë¸ (Parent Delegation Model)

í´ë˜ìŠ¤ë¥¼ ë¡œë”©í•  ë•Œ ë‹¤ìŒ ìˆœì„œë¡œ ì‹œë„í•¨:

```
ìê¸° ìì‹  â†’ ë¶€ëª¨ì—ê²Œ ìœ„ì„ â†’ ë¶€ëª¨ ë¡œë” â†’ Bootstrap ë¡œë”
```

> âœ… ë¶€ëª¨ê°€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ìì‹ ì´ ì§ì ‘ ë¡œë”© ì‹œë„
>  ì´ ë°©ì‹ ë•ë¶„ì— **í•µì‹¬ APIê°€ ì˜¤ì—¼ë˜ì§€ ì•ŠìŒ**

------

### 5. ClassLoader ì£¼ìš” ë©”ì„œë“œ

```
ClassLoader loader = ClassLoader.getSystemClassLoader();

// í´ë˜ìŠ¤ ë¡œë“œ
Class<?> clazz = loader.loadClass("com.example.MyClass");

// í´ë˜ìŠ¤ ë¡œë” í™•ì¸
System.out.println(clazz.getClassLoader()); // ApplicationClassLoader
```

#### ì£¼ìš” API

| ë©”ì„œë“œ                   | ì„¤ëª…                                              |
| ------------------------ | ------------------------------------------------- |
| `loadClass(String name)` | í´ë˜ìŠ¤ ë¡œë”© ì‹œë„                                  |
| `findClass(String name)` | ì§ì ‘ í´ë˜ìŠ¤ ì°¾ê¸° (ì˜¤ë²„ë¼ì´ë“œìš©)                   |
| `defineClass(...)`       | byte[] â†’ Class ê°ì²´ ìƒì„± (ì§ì ‘ ë¡œë” êµ¬í˜„ ì‹œ ì‚¬ìš©) |

------

### 6. ì‚¬ìš©ì ì •ì˜ ClassLoader ì˜ˆì‹œ

```
public class MyClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        byte[] b = loadClassDataFromSomewhere(name);
        return defineClass(name, b, 0, b.length);
    }

    private byte[] loadClassDataFromSomewhere(String name) {
        // íŒŒì¼ ì½ê¸°, ë„¤íŠ¸ì›Œí¬ ë‹¤ìš´ë¡œë“œ ë“±
    }
}
```

> â— ì‚¬ìš©ì ì •ì˜ ë¡œë”ëŠ” ë³´ì•ˆ, ê²©ë¦¬, AOT ë””ì½”ë”© ë“±ì—ì„œ ìœ ìš©í•¨

------

### 7. í´ë˜ìŠ¤ ë¡œë” ê²©ë¦¬ì™€ ì¶©ëŒ

í´ë˜ìŠ¤ ë¡œë”ê°€ ë‹¤ë¥´ë©´ **ê°™ì€ í´ë˜ìŠ¤ë¼ë„ ì„œë¡œ ë‹¤ë¥¸ ê²ƒìœ¼ë¡œ ê°„ì£¼**ëœë‹¤.

```
ClassLoader loader1 = new MyClassLoader();
ClassLoader loader2 = new MyClassLoader();

Class<?> c1 = loader1.loadClass("com.example.Foo");
Class<?> c2 = loader2.loadClass("com.example.Foo");

System.out.println(c1 == c2); // false
```

------

### 8. Springê³¼ í´ë˜ìŠ¤ ë¡œë”

- Spring FrameworkëŠ” **ClassPath scanning**ì„ ìœ„í•´ `ClassLoader`ë¥¼ ì‚¬ìš©
- Spring Bootì—ì„œëŠ” **DevTools**ë¡œ ì¸í•´ **í´ë˜ìŠ¤ ë¦¬ë¡œë“œ**ë¥¼ ìœ„í•œ ë³„ë„ í´ë˜ìŠ¤ ë¡œë”ê°€ ì‚¬ìš©ë¨
- `Thread.currentThread().getContextClassLoader()`ëŠ” ì¢…ì¢… ìŠ¤í”„ë§/ì„œë“œíŒŒí‹° í”„ë ˆì„ì›Œí¬ì—ì„œ ì¤‘ìš”í•œ ì—­í• ì„ í•¨

------

### 9. í´ë˜ìŠ¤ ë¡œë” ê´€ë ¨ ë””ë²„ê¹… íŒ

```
Class<?> clazz = Class.forName("com.example.MyClass");
System.out.println(clazz.getClassLoader());

ClassLoader loader = clazz.getClassLoader();
while (loader != null) {
    System.out.println(loader);
    loader = loader.getParent();
}
```

------

### 10. ì •ë¦¬: í´ë˜ìŠ¤ ë¡œë”ì˜ ì—­í• 

| ì—­í•           | ì„¤ëª…                                      |
| ------------- | ----------------------------------------- |
| `.class` ë¡œë”© | íŒŒì¼ ì‹œìŠ¤í…œ, JAR, ë„¤íŠ¸ì›Œí¬ ë“±             |
| ë³´ì•ˆ          | íŠ¹ì • ë¡œë” ë²”ìœ„ ë‚´ í´ë˜ìŠ¤ë§Œ ì ‘ê·¼ í—ˆìš©      |
| ê²©ë¦¬          | ì›¹ ì»¨í…Œì´ë„ˆ ê°„ ê²©ë¦¬, í”ŒëŸ¬ê·¸ì¸ ì‹œìŠ¤í…œ      |
| ì»¤ìŠ¤í„°ë§ˆì´ì§•  | ë™ì  ë°”ì´íŠ¸ì½”ë“œ ì‚½ì… (ì˜ˆ: ByteBuddy, ASM) |

------

### 11. ì‹¤ì „ í™œìš© ì˜ˆì‹œ

- **Tomcat**: ì›¹ ì•±ë§ˆë‹¤ ë³„ë„ ClassLoader ìš´ì˜
- **Spring Boot DevTools**: ìë™ ë¦¬ë¡œë“œìš© ClassLoader ê²©ë¦¬
- **OSGi**: ì™„ì „í•œ ëª¨ë“ˆí™” ì§€ì› ìœ„í•œ ClassLoader ê²©ë¦¬ ëª¨ë¸

## Garbage Collection ì•Œê³ ë¦¬ì¦˜

### 1. Garbage Collection(GC)ì´ë€?

Garbage Collectionì€ **ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ íƒì§€í•˜ê³  ì œê±°**í•¨ìœ¼ë¡œì¨ ë©”ëª¨ë¦¬ë¥¼ íšŒìˆ˜í•˜ëŠ” **JVMì˜ ìë™ ë©”ëª¨ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ**ì´ë‹¤.

> ğŸ¯ ëª©í‘œ: ê°œë°œìê°€ `free()`ë‚˜ `delete` ê°™ì€ ìˆ˜ë™ ë©”ëª¨ë¦¬ í•´ì œë¥¼ í•˜ì§€ ì•Šì•„ë„ **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì—†ì´ ì•ˆì „í•œ í”„ë¡œê·¸ë˜ë°**ì„ ê°€ëŠ¥í•˜ê²Œ í•¨

------

### 2. GCê°€ ê´€ë¦¬í•˜ëŠ” ë©”ëª¨ë¦¬ ì˜ì—­: Java Heap

```
Java Heap
 â”œâ”€ Young Generation
 â”‚   â”œâ”€ Eden
 â”‚   â””â”€ Survivor (S0, S1)
 â””â”€ Old Generation
```

- **Young Generation (ì‹ ìƒ ì˜ì—­)**: ìƒˆë¡œ ìƒì„±ëœ ê°ì²´ê°€ ë°°ì¹˜ë¨
- **Old Generation (ë…¸ë…„ ì˜ì—­)**: ì˜¤ë˜ ì‚´ì•„ë‚¨ì€ ê°ì²´ê°€ ì´ì£¼ë¨
- **Permanent Generation / Metaspace**: í´ë˜ìŠ¤ ë©”íƒ€ ì •ë³´ (Java 8ë¶€í„° Metaspaceë¡œ ì´ë™)

------

### 3. GC ì£¼ìš” ê°œë…

| ê°œë…                  | ì„¤ëª…                                                         |
| --------------------- | ------------------------------------------------------------ |
| **Minor GC**          | Young ì˜ì—­ì—ì„œ ìˆ˜í–‰                                          |
| **Major/Full GC**     | Old ì˜ì—­(ë˜ëŠ” ì „ì²´ Heap í¬í•¨)ì„ ëŒ€ìƒìœ¼ë¡œ ìˆ˜í–‰                |
| **Stop-The-World**    | GC ìˆ˜í–‰ ì‹œ ëª¨ë“  ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤ë ˆë“œ ì¼ì‹œ ì •ì§€                |
| **GC Root**           | íƒìƒ‰ì˜ ê¸°ì¤€ì´ ë˜ëŠ” ê°ì²´ (`Thread`, `Static`, `JNI`, `System Class`) |
| **Reachability ë¶„ì„** | ê°ì²´ ì°¸ì¡° ê·¸ë˜í”„ë¥¼ ë”°ë¼ ì‚´ì•„ ìˆëŠ” ê°ì²´ íƒìƒ‰                  |

------

### 4. Javaì˜ ì£¼ìš” GC ì•Œê³ ë¦¬ì¦˜

#### ğŸ”¹ 4.1 Serial GC

- **ë‹¨ì¼ ìŠ¤ë ˆë“œ ê¸°ë°˜**, ëª¨ë“  GC ì‘ì—…ì„ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë¡œ ìˆ˜í–‰
- ë©€í‹°ì½”ì–´ í™œìš© ëª»í•¨ â†’ **ì‘ì€ ë©”ëª¨ë¦¬ì˜ í´ë¼ì´ì–¸íŠ¸ í™˜ê²½**ì— ì í•©

```
-XX:+UseSerialGC
```

------

#### ğŸ”¹ 4.2 Parallel GC (ë˜ëŠ” Throughput Collector)

- **ë©€í‹°ìŠ¤ë ˆë“œ ê¸°ë°˜ GC**
- `Young GC`ì™€ `Old GC` ëª¨ë‘ ë³‘ë ¬ ì²˜ë¦¬
- Throughput(ì „ì²´ ì²˜ë¦¬ëŸ‰)ì„ ë†’ì´ëŠ” ë° ì¤‘ì 

```
-XX:+UseParallelGC
```

------

#### ğŸ”¹ 4.3 CMS (Concurrent Mark Sweep) GC âŒ [Deprecated]

- **Old ì˜ì—­ì—ì„œ Stop-The-Worldì„ ìµœì†Œí™”**í•˜ë ¤ëŠ” ëª©ì 
- ë§ˆí¬(Mark) â†’ Sweep ë‹¨ê³„ê°€ **ë™ì‹œ ì‹¤í–‰**
- ë‹¨ì : Fragmentation ë°œìƒ ê°€ëŠ¥, Java 9ë¶€í„° deprecated

```
-XX:+UseConcMarkSweepGC
```

------

#### ğŸ”¹ 4.4 G1 GC (Garbage First)

- Java 9 ì´í›„ ê¸°ë³¸ GC
- **Heapì„ Region ë‹¨ìœ„ë¡œ ë¶„í• ** (Young/Oldë¥¼ Region ë‹¨ìœ„ë¡œ í˜¼í•© ê´€ë¦¬)
- **Concurrent GC + Stop-The-World GCì˜ í•˜ì´ë¸Œë¦¬ë“œ**
- í° Heapì—ì„œë„ ì˜ˆì¸¡ ê°€ëŠ¥í•œ GC ì‹œê°„ ì œê³µ

```
-XX:+UseG1GC
```

| íŠ¹ì§•              | ì„¤ëª…                                         |
| ----------------- | -------------------------------------------- |
| Region ê¸°ë°˜       | Heap ì „ì²´ë¥¼ ê³ ì •ëœ í¬ê¸°ì˜ Regionìœ¼ë¡œ ë‚˜ëˆ”    |
| Evacuation        | GC ëŒ€ìƒ Regionì˜ ê°ì²´ë¥¼ ë‹¤ë¥¸ Regionìœ¼ë¡œ ë³µì‚¬ |
| Pause Time Target | `-XX:MaxGCPauseMillis=200` ë“± ì„¤ì • ê°€ëŠ¥      |

------

#### ğŸ”¹ 4.5 ZGC (Java 11+)

- **ì´ˆì € ì§€ì—°(Low Latency) GC**
- ëŒ€ë¶€ë¶„ì˜ GC ì‘ì—…ì´ **ìŠ¤ë ˆë“œì™€ ë³‘ë ¬ë¡œ ìˆ˜í–‰**, Stop-The-WorldëŠ” **ëª‡ ë°€ë¦¬ì´ˆ ë¯¸ë§Œ**

```
-XX:+UseZGC
```

| íŠ¹ì§•                         | ì„¤ëª…                |
| ---------------------------- | ------------------- |
| ë©€í‹° ìŠ¤ë ˆë“œ ë³‘ë ¬ ë§ˆí‚¹        | ë§¤ìš° ë¹ ë¥¸ ë§ˆí‚¹      |
| GC ì‘ì—… ëŒ€ë¶€ë¶„ì´ **non-STW** | ë§¤ìš° ì§§ì€ ë©ˆì¶¤      |
| ì»¬ëŸ¬ í¬ì¸í„°(Color Pointer)   | ê°ì²´ ì°¸ì¡° ìƒíƒœ ì¶”ì  |

------

#### ğŸ”¹ 4.6 Shenandoah GC (Red Hat, Java 12+)

- ZGCì™€ ë¹„ìŠ·í•œ ì² í•™ â†’ **pause time ë‹¨ì¶•**
- **Region-based**, **concurrent compacting GC**

```
-XX:+UseShenandoahGC
```

------

### 5. GC ì•Œê³ ë¦¬ì¦˜ ë¹„êµ

| GC         | ë©€í‹°ìŠ¤ë ˆë“œ | ì§€ì—° ì‹œê°„ | Throughput | ë©”ëª¨ë¦¬ í¬ê¸° | ë¹„ê³                   |
| ---------- | ---------- | --------- | ---------- | ----------- | --------------------- |
| Serial     | âŒ          | ë†’ìŒ      | ë‚®ìŒ       | ì†Œí˜•        | ë‹¨ì¼ ìŠ¤ë ˆë“œ           |
| Parallel   | âœ…          | ì¤‘ê°„      | ë†’ìŒ       | ì¤‘í˜•~ëŒ€í˜•   | ê¸°ë³¸ GC (Java 8)      |
| CMS        | âœ…          | ë‚®ìŒ      | ì¤‘ê°„       | ì¤‘í˜•        | ì¡°ê° ë°œìƒ, Deprecated |
| G1         | âœ…          | ë‚®ìŒ      | ë†’ìŒ       | ì¤‘~ëŒ€í˜•     | ê¸°ë³¸ GC (Java 9~17)   |
| ZGC        | âœ…          | ë§¤ìš° ë‚®ìŒ | ë†’ìŒ       | ëŒ€í˜•        | STW < 2ms             |
| Shenandoah | âœ…          | ë§¤ìš° ë‚®ìŒ | ì¤‘~ë†’ìŒ    | ëŒ€í˜•        | OpenJDK ê¸°ë°˜          |

------

### 6. GC íŠœë‹ ì£¼ìš” ì˜µì…˜

```
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-Xlog:gc*:file=gc.log:time,uptime,level,tags
```

------

### 7. GC ë¡œê·¸ ì˜ˆì‹œ

```
[GC pause (G1 Evacuation Pause) (young), 0.0056789 secs]
   [Parallel Time: 4.5 ms, GC Workers: 4]
   [Eden: 12M(12M)->0B(10M) Survivors: 2M->2M Heap: 22M(256M)->12M(256M)]
```

------

### 8. GC íŠœë‹ ì „ëµ

| ìƒí™©             | ì¡°ì¹˜                                 |
| ---------------- | ------------------------------------ |
| ì‘ë‹µ ì§€ì—° ë¬¸ì œ   | G1GC, ZGC ì‚¬ìš© ê³ ë ¤                  |
| Throughput ì¤‘ì‹œ  | Parallel GC ë˜ëŠ” G1                  |
| GC ë¹ˆë²ˆ          | Heap í¬ê¸° ì¡°ì •, Minor GC íšŸìˆ˜ ì¤„ì´ê¸° |
| Full GC ì¦ìŒ     | ê°ì²´ ìˆ˜ëª… ë¶„ì„ â†’ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì˜ì‹¬    |
| OutOfMemoryError | Heap í¬ê¸° í™•ëŒ€ or ë¡œì§ ì ê²€          |

------

### 9. ì‹¤ë¬´ì—ì„œ ìì£¼ ì“°ëŠ” ì¡°í•©

| ëª©ì              | ì¶”ì²œ ì¡°í•©                                                    |
| ---------------- | ------------------------------------------------------------ |
| ì¼ë°˜ ì„œë²„        | `G1GC` + `MaxGCPauseMillis=200`                              |
| ì‹¤ì‹œê°„/ì§€ì—° ë¯¼ê° | `ZGC` or `ShenandoahGC`                                      |
| JVM íŠœë‹ í•„ìš”    | `-Xms`, `-Xmx`, GC ë¡œê¹…, `jvisualvm`, `jstat`, `GCViewer` ë“± ë³‘í–‰ í™œìš© |

------

### 10. ê´€ë ¨ íˆ´

- `jstat -gc <pid>`: GC í†µê³„
- `jvisualvm`: ì‹œê°ì  GC ëª¨ë‹ˆí„°ë§
- `GCViewer`: GC ë¡œê·¸ ì‹œê°í™”
- `Flight Recorder`, `Mission Control`: GC + ìŠ¤ë ˆë“œ + í™ ì¢…í•© ë¶„ì„

## ë©”ëª¨ë¦¬ ê´€ë¦¬ êµ¬ì¡° (Heap, Stack, Metaspace)

> JVM Memory Management Structure (Heap, Stack, Metaspace ë“±)

------

### 1. JVM ë©”ëª¨ë¦¬ êµ¬ì¡° ì „ì²´ ê°œìš”

JVM ë©”ëª¨ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì—¬ëŸ¬ **ì˜ì—­(Area)** ìœ¼ë¡œ ë‚˜ë‰˜ì–´ ê´€ë¦¬ëœë‹¤.

```
+---------------------------------------------------+
|               Java Virtual Machine                |
+------------------------+--------------------------+
|   Method Area (â†’ Metaspace in Java 8+)            |
|   Heap                                            |
|   Stack (Thread-local)                            |
|   Native Method Stack                             |
|   PC Register                                     |
|   Runtime Constant Pool                           |
+---------------------------------------------------+
```

------

### 2. í™(Heap) ì˜ì—­

#### ê°œìš”

- **ê°ì²´(instance)** ì™€ **ë°°ì—´(array)** ì´ ì €ì¥ë˜ëŠ” **ê°€ì¥ í° ë©”ëª¨ë¦¬ ê³µê°„**
- **Garbage Collection ëŒ€ìƒ**
- ìŠ¤ë ˆë“œ ê°„ **ê³µìœ ë˜ëŠ” ì˜ì—­**

#### ë‚´ë¶€ êµ¬ì¡°

- **Young Generation (Eden + Survivor)**
- **Old Generation (Tenured)**
- GCê°€ ì´ ì˜ì—­ì„ ì£¼ë¡œ ê´€ë¦¬

#### íŠ¹ì§•

| í•­ëª©             | ì„¤ëª…                                          |
| ---------------- | --------------------------------------------- |
| ê°ì²´ ì €ì¥ì†Œ      | `new` í‚¤ì›Œë“œë¡œ ìƒì„±ëœ ê°ì²´                    |
| GC ëŒ€ìƒ          | ì°¸ì¡°ë˜ì§€ ì•ŠëŠ” ê°ì²´                            |
| OutOfMemoryError | `java.lang.OutOfMemoryError: Java heap space` |

------

### 3. ìŠ¤íƒ(Stack) ì˜ì—­

#### ê°œìš”

- ê° **ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë©”ëª¨ë¦¬ ê³µê°„**
- ë©”ì„œë“œ í˜¸ì¶œ ì‹œ **í”„ë ˆì„(frame)** ë‹¨ìœ„ë¡œ push
- ë©”ì„œë“œ ì¢…ë£Œ ì‹œ pop

#### í¬í•¨ ìš”ì†Œ

- ì§€ì—­ ë³€ìˆ˜, ë§¤ê°œë³€ìˆ˜
- ë¦¬í„´ ê°’, ì—°ì‚° ì¤‘ê°„ê°’
- í˜¸ì¶œ ìŠ¤íƒ ì •ë³´

#### íŠ¹ì§•

| í•­ëª©           | ì„¤ëª…                                               |
| -------------- | -------------------------------------------------- |
| ë©”ì„œë“œ ì‹¤í–‰ ì‹œ | í”„ë ˆì„ ìƒì„±                                        |
| ì¢…ë£Œ ì‹œ        | í”„ë ˆì„ ì œê±°                                        |
| ì†ë„           | ë§¤ìš° ë¹ ë¦„ (LIFO êµ¬ì¡°)                              |
| ì˜ˆì™¸           | `java.lang.StackOverflowError` (ì¬ê·€ ë¬´í•œ í˜¸ì¶œ ë“±) |

------

### 4. ë©”íƒ€ìŠ¤í˜ì´ìŠ¤(Metaspace)

#### ê°œìš”

- Java 8ë¶€í„° **Permanent Generation (PermGen)**ì„ ëŒ€ì²´
- í´ë˜ìŠ¤ì˜ **ë©”íƒ€ë°ì´í„°(Class ê°ì²´, method info ë“±)** ì €ì¥ ê³µê°„
- JVMì´ ì•„ë‹Œ **OS ë„¤ì´í‹°ë¸Œ ë©”ëª¨ë¦¬**ë¥¼ ì‚¬ìš©

#### íŠ¹ì§•

| í•­ëª©      | ì„¤ëª…                                             |
| --------- | ------------------------------------------------ |
| ì €ì¥ ëŒ€ìƒ | í´ë˜ìŠ¤ ì •ì˜ ì •ë³´, ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜                |
| í¬ê¸° ê´€ë¦¬ | ê¸°ë³¸ ë¬´ì œí•œ (`-XX:MaxMetaspaceSize`ë¡œ ì œí•œ ê°€ëŠ¥) |
| GC ëŒ€ìƒ   | ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” í´ë˜ìŠ¤ ì–¸ë¡œë“œ ê°€ëŠ¥                 |
| ì˜ˆì™¸      | `java.lang.OutOfMemoryError: Metaspace`          |

------

### 5. PC Register

- **ê° ìŠ¤ë ˆë“œë§ˆë‹¤ ìƒì„±ë˜ëŠ” ë ˆì§€ìŠ¤í„°**
- í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ **JVM ëª…ë ¹ì–´ ì£¼ì†Œ**ë¥¼ ì €ì¥
- JVMì´ ì–´ë–¤ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  ìˆëŠ”ì§€ ì¶”ì 

------

### 6. Native Method Stack

- **JNI (Java Native Interface)** ë¡œ í˜¸ì¶œëœ **C/C++ native ì½”ë“œ** ì‹¤í–‰ì„ ìœ„í•œ ê³µê°„
- ì˜ˆì™¸: `java.lang.StackOverflowError` ë˜ëŠ” ë„¤ì´í‹°ë¸Œ ë©”ëª¨ë¦¬ ì¶©ëŒ ë°œìƒ ê°€ëŠ¥

------

### 7. Runtime Constant Pool

- ê° í´ë˜ìŠ¤ë‚˜ ì¸í„°í˜ì´ìŠ¤ì— ëŒ€í•œ **ìƒìˆ˜ í’€(constant pool)** ì €ì¥ ì˜ì—­
- ë¦¬í„°ëŸ´ ë¬¸ìì—´, ìƒìˆ˜ ê°’, ë©”ì„œë“œ/í•„ë“œ ì°¸ì¡° ì •ë³´ ë“±

ì˜ˆ:

```
String a = "hello"; // ë¬¸ìì—´ ë¦¬í„°ëŸ´ â†’ ìƒìˆ˜ í’€ì— ì €ì¥
```

------

### 8. ë©”ëª¨ë¦¬ êµ¬ì¡° ìš”ì•½ ë¹„êµ

| ì˜ì—­         | ìš©ë„              | ê´€ë¦¬ ì£¼ì²´ | ì˜¤ë¥˜                 |
| ------------ | ----------------- | --------- | -------------------- |
| Heap         | ê°ì²´ ì €ì¥         | GC        | `OutOfMemoryError`   |
| Stack        | í˜¸ì¶œ/ì§€ì—­ ë³€ìˆ˜    | JVM       | `StackOverflowError` |
| Metaspace    | í´ë˜ìŠ¤ ë©”íƒ€ë°ì´í„° | OS ë©”ëª¨ë¦¬ | `OutOfMemoryError`   |
| PC Register  | ë°”ì´íŠ¸ì½”ë“œ ì£¼ì†Œ   | JVM       | ì—†ìŒ                 |
| Native Stack | JNI ë©”ì„œë“œ ì‹¤í–‰   | JVM/OS    | `StackOverflowError` |

------

### 9. JVM ë©”ëª¨ë¦¬ ì„¤ì • ì˜µì…˜

```
-Xms512m                 # ì´ˆê¸° í™ í¬ê¸°
-Xmx2048m                # ìµœëŒ€ í™ í¬ê¸°
-Xss1m                   # ìŠ¤íƒ í¬ê¸° ì„¤ì •
-XX:MetaspaceSize=128m   # ë©”íƒ€ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸° í¬ê¸°
-XX:MaxMetaspaceSize=512m # ë©”íƒ€ìŠ¤í˜ì´ìŠ¤ ìµœëŒ€ í¬ê¸°
```

------

### 10. ì‹œê°ì  ì •ë¦¬

```
[ JVM Process ]
 â”œâ”€ Heap (shared, GC ëŒ€ìƒ)
 â”‚   â”œâ”€ Eden
 â”‚   â”œâ”€ Survivor (S0/S1)
 â”‚   â””â”€ Old
 â”œâ”€ Stack (per thread)
 â”œâ”€ Metaspace (class metadata, non-heap)
 â”œâ”€ PC Register
 â””â”€ Native Method Stack
```

------

### 11. ì‹¤ë¬´ íŒ

- `Heap`ì´ ì»¤ë„ `Stack`ì€ ì‘ì„ ìˆ˜ ìˆë‹¤ â†’ ëŒ€ëŸ‰ ì¬ê·€ ì‹œ ìŠ¤íƒ ì˜¤ë¥˜ ê°€ëŠ¥
- í´ë˜ìŠ¤ ë¡œë”©ì´ ë§ìœ¼ë©´ `Metaspace` ì¦ê°€ â†’ ì œí•œ í•„ìš”
- `Heap Dump` ë¶„ì„ ë„êµ¬: `jmap`, `MAT`, `VisualVM`, `YourKit`
- ìŠ¤ë ˆë“œ ìˆ˜ê°€ ë§ë‹¤ë©´ `-Xss` íŠœë‹ìœ¼ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ ìµœì í™” í•„ìš”

## Unsafe API

### 1. `Unsafe`ë€ ë¬´ì—‡ì¸ê°€?

- **`sun.misc.Unsafe`**ëŠ” Javaì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ í—ˆìš©ë˜ì§€ ì•ŠëŠ” **ë‚®ì€ ìˆ˜ì¤€ì˜ ë©”ëª¨ë¦¬ ì œì–´ ê¸°ëŠ¥**ì„ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤.
- ì˜ˆë¥¼ ë“¤ë©´:
  - ì§ì ‘ **ë©”ëª¨ë¦¬ í• ë‹¹/í•´ì œ**
  - ê°ì²´ì˜ **í•„ë“œ ì˜¤í”„ì…‹ì— ì§ì ‘ ì ‘ê·¼**
  - **CAS ì—°ì‚°** (Compare-And-Swap)
  - **í´ë˜ìŠ¤ ì •ì˜** (defineClass)
- **JVM ë‚´ë¶€ë‚˜ ê³ ì„±ëŠ¥ ë¼ì´ë¸ŒëŸ¬ë¦¬(Lock-Free Queue ë“±)** ì—ì„œë§Œ ì‚¬ìš©ì„ ê¶Œì¥

------

### 2. ì™œ ìœ„í—˜í•œê°€?

| ì´ìœ                  | ì„¤ëª…                                              |
| -------------------- | ------------------------------------------------- |
| íƒ€ì… ì•ˆì „ì„± ë¬´ì‹œ     | ì•„ë¬´ í•„ë“œì—ë‚˜ ê°’ì„ ì‚½ì… ê°€ëŠ¥                      |
| GC ìš°íšŒ              | ë©”ëª¨ë¦¬ë¥¼ ì§ì ‘ í• ë‹¹ â†’ GCì— ì˜í•´ ê´€ë¦¬ë˜ì§€ ì•ŠìŒ      |
| ë³´ì•ˆ ë¬´ì‹œ            | private í•„ë“œ, final í•„ë“œë„ ì¡°ì‘ ê°€ëŠ¥              |
| JVM í¬ë˜ì‹œ ìœ ë°œ ê°€ëŠ¥ | ì˜ëª»ëœ ì˜¤í”„ì…‹ ì ‘ê·¼ì€ SIGSEGV ì˜¤ë¥˜ë¡œ JVM ë‹¤ìš´ ê°€ëŠ¥ |

> ê·¸ë˜ì„œ Java 9ë¶€í„°ëŠ” `jdk.internal.misc.Unsafe`ë¡œ ì´ë™ë˜ê³ , `--add-exports` ì˜µì…˜ ì—†ì´ ì‚¬ìš© ë¶ˆê°€

------

### 3. `Unsafe` ì¸ìŠ¤í„´ìŠ¤ íšë“ ë°©ë²•

ì •ìƒì ì¸ ë°©ë²•ìœ¼ë¡œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ê³ , ë¦¬í”Œë ‰ì…˜ì„ ì¨ì•¼ í•¨:

```
import sun.misc.Unsafe;

import java.lang.reflect.Field;

public class UnsafeAccess {
    public static Unsafe getUnsafe() throws Exception {
        Field f = Unsafe.class.getDeclaredField("theUnsafe");
        f.setAccessible(true);
        return (Unsafe) f.get(null);
    }
}
```

------

### 4. ì£¼ìš” ê¸°ëŠ¥ë³„ API ì„¤ëª…

------

#### ğŸ”¸ 4.1 ë©”ëª¨ë¦¬ ì§ì ‘ ì œì–´

```
long address = unsafe.allocateMemory(8); // 8ë°”ì´íŠ¸ í• ë‹¹
unsafe.putLong(address, 123456789L);     // í•´ë‹¹ ì£¼ì†Œì— ê°’ ì €ì¥
long value = unsafe.getLong(address);    // í•´ë‹¹ ì£¼ì†Œì—ì„œ ê°’ ë¡œë“œ
unsafe.freeMemory(address);              // í•´ì œ
```

| ë©”ì„œë“œ                   | ì„¤ëª…                |
| ------------------------ | ------------------- |
| `allocateMemory(size)`   | OS ë©”ëª¨ë¦¬ ì§ì ‘ í• ë‹¹ |
| `freeMemory(address)`    | ì§ì ‘ í•´ì œ           |
| `putXxx(address, value)` | ì£¼ì†Œì— ê°’ ì €ì¥      |
| `getXxx(address)`        | ì£¼ì†Œì—ì„œ ê°’ ì½ê¸°    |

------

#### ğŸ”¸ 4.2 ê°ì²´ í•„ë“œ ì§ì ‘ ì ‘ê·¼

```
Field f = MyClass.class.getDeclaredField("x");
long offset = unsafe.objectFieldOffset(f);
unsafe.putInt(myObject, offset, 42); // ê°•ì œë¡œ xì— 42 ì €ì¥
```

| ë©”ì„œë“œ                       | ì„¤ëª…                    |
| ---------------------------- | ----------------------- |
| `objectFieldOffset(Field f)` | í•´ë‹¹ í•„ë“œì˜ ì˜¤í”„ì…‹ êµ¬í•¨ |
| `putInt(obj, offset, val)`   | í•„ë“œì— ì§ì ‘ ê°’ ì €ì¥     |
| `getInt(obj, offset)`        | í•„ë“œì—ì„œ ì§ì ‘ ê°’ ì½ê¸°   |

------

#### ğŸ”¸ 4.3 CAS(Compare-And-Swap) ì—°ì‚°

```
boolean success = unsafe.compareAndSwapInt(obj, offset, 10, 20);
```

- **ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë½ ì—†ì´ ì•ˆì „í•˜ê²Œ ê°’ì„ êµì²´**
- `java.util.concurrent.atomic` íŒ¨í‚¤ì§€ êµ¬í˜„ì˜ í•µì‹¬

------

#### ğŸ”¸ 4.4 í´ë˜ìŠ¤ ì •ì˜

```
Class<?> clazz = unsafe.defineClass(null, classBytes, 0, classBytes.length, null, null);
```

- ë°”ì´íŠ¸ì½”ë“œë¥¼ ì§ì ‘ JVMì— ë¡œë“œ
- ìŠ¤í”„ë§, í”„ë¡ì‹œ í”„ë ˆì„ì›Œí¬, ByteBuddy ë“±ì´ ì‚¬ìš©

------

#### ğŸ”¸ 4.5 ê°ì²´ ìƒì„± (ìƒì„±ì ë¬´ì‹œ)

```
MyClass obj = (MyClass) unsafe.allocateInstance(MyClass.class);
```

- ìƒì„±ìë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ê°ì²´ ìƒì„±
- ORM, í”„ë ˆì„ì›Œí¬ ë‚´ë¶€ì—ì„œ ì‚¬ìš©

------

### 5. ëŒ€í‘œì ì¸ ì‚¬ìš© ì‚¬ë¡€

| ë¶„ì•¼                  | ì„¤ëª…                                             |
| --------------------- | ------------------------------------------------ |
| **ê³ ì„±ëŠ¥ ë¼ì´ë¸ŒëŸ¬ë¦¬** | Netty, Cassandra, Kafka ë“±                       |
| **ë½ í”„ë¦¬ ì•Œê³ ë¦¬ì¦˜**  | CAS ê¸°ë°˜ êµ¬ì¡° êµ¬í˜„                               |
| **ë°”ì´íŠ¸ì½”ë“œ í”„ë¡ì‹œ** | ASM, ByteBuddy ë“±ì—ì„œ í´ë˜ìŠ¤ ì§ì ‘ ì •ì˜           |
| **ë©”ëª¨ë¦¬ ìµœì í™”**     | JVM í™ ì™¸ ì§ì ‘ ë©”ëª¨ë¦¬ ì‚¬ìš© (Off-Heap)            |
| **ì„±ëŠ¥ íŠœë‹**         | Unsafe ê¸°ë°˜ êµ¬ì¡°ì²´ì²˜ëŸ¼ ë™ì‘í•˜ëŠ” í´ë˜ìŠ¤ ì‘ì„± ê°€ëŠ¥ |

------

### 6. Java 9 ì´í›„ì˜ ë³€í™”

| í•­ëª©                             | ì„¤ëª…                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| ëª¨ë“ˆí™”ë¡œ ì¸í•´ **ê¸°ë³¸ ì ‘ê·¼ ë¶ˆê°€** | `Unsafe`ëŠ” `jdk.unsupported` ëª¨ë“ˆë¡œ ë¶„ë¦¬ë¨                   |
| ì‚¬ìš©í•˜ë ¤ë©´ `--add-exports` í•„ìš”  | ì˜ˆ: `--add-exports java.base/jdk.internal.misc=ALL-UNNAMED`  |
| **ëŒ€ì²´ APIë¡œ ì „í™˜ ìœ ë„ ì¤‘**      | `VarHandle`, `ByteBuffer`, `Foreign Memory API` (Project Panama) ë“± |

------

### 7. ìœ„í—˜ì„± ì˜ˆì‹œ

```
// final í•„ë“œ ìš°íšŒ
class Secret {
    private final int x = 42;
}
Field f = Secret.class.getDeclaredField("x");
long offset = unsafe.objectFieldOffset(f);
unsafe.putInt(secretInstance, offset, 999); // final ë¬´ë ¥í™”
```

ğŸ‘‰ ë³´ì•ˆìƒ ì¹˜ëª…ì ì´ê³ , êµ¬ì¡°ì  ì•ˆì •ì„±ì´ ì™„ì „íˆ ë¬´ë„ˆì§

------

### 8. ì •ë¦¬: ì¥ë‹¨ì 

| í•­ëª©   | ì¥ì                            | ë‹¨ì                |
| ------ | ------------------------------ | ------------------ |
| ì„±ëŠ¥   | GC ìš°íšŒ, zero-copy ê°€ëŠ¥        | GCì™€ ë¶„ë¦¬ë˜ì–´ ìœ„í—˜ |
| ì œì–´ë ¥ | Javaê°€ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ì‘ì—… ê°€ëŠ¥ | íƒ€ì… ì•ˆì „ì„± ë¬´ì‹œ   |
| ì‹¤ìš©ì„± | ê³ ì„±ëŠ¥ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìœ ìš©       | JVM í¬ë˜ì‹œ ê°€ëŠ¥ì„±  |

------

### 9. ëŒ€ì²´ ê¸°ìˆ 

| ëª©ì            | ëŒ€ì²´                                                    |
| -------------- | ------------------------------------------------------- |
| ê°ì²´ í•„ë“œ ì ‘ê·¼ | `Reflection`, `VarHandle`                               |
| CAS ì—°ì‚°       | `Atomic*` í´ë˜ìŠ¤, `VarHandle.compareAndSet()`           |
| Off-Heap       | `ByteBuffer`, `sun.nio.ch.DirectBuffer`, Panama FFM API |
| Class ì •ì˜     | `ClassLoader.defineClass()`, ByteBuddy                  |

------

### 10. ì‹¤ë¬´ ì¡°ì–¸

- **ì ˆëŒ€ ì¼ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ì§ì ‘ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ**
- ë°˜ë“œì‹œ ì„±ëŠ¥ ë˜ëŠ” ê¸°ìˆ ì  ì´ìœ ê°€ ëª…í™•í•œ ê²½ìš°ì—ë§Œ ì‹ ì¤‘íˆ ì‚¬ìš©
- Java 17 ì´ìƒì—ì„œëŠ” ê°€ëŠ¥í•˜ë©´ **VarHandle**, **Panama API**, **Project Loom** ê¸°ë°˜ êµ¬ì¡°ë¡œ ì „í™˜ ê¶Œì¥

## JVM íŠœë‹ ë° í”„ë¡œíŒŒì¼ë§ (`jvisualvm`, `jconsole`, `Flight Recorder`)

> ì£¼ìš” ë„êµ¬: `jvisualvm`, `jconsole`, `Java Flight Recorder`

------

### 1. JVM íŠœë‹ì´ë€?

- **JVM ì˜µì…˜ì„ ì¡°ì •**í•˜ì—¬ ë©”ëª¨ë¦¬, GC, ìŠ¤ë ˆë“œ, JIT ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” ì‘ì—…
- ëª©ì :
  - GC ì§€ì—° ì‹œê°„ ë‹¨ì¶•
  - OOM ë°©ì§€
  - CPU ê³¼ë¶€í•˜ ë°©ì§€
  - ì„œë¹„ìŠ¤ ì‘ë‹µ ì†ë„ í–¥ìƒ

------

### 2. JVM ê¸°ë³¸ ì„±ëŠ¥ ê´€ë ¨ ì˜µì…˜

| ì˜µì…˜                         | ì„¤ëª…                 |
| ---------------------------- | -------------------- |
| `-Xms512m`                   | ì´ˆê¸° Heap í¬ê¸°       |
| `-Xmx2g`                     | ìµœëŒ€ Heap í¬ê¸°       |
| `-Xss512k`                   | ìŠ¤íƒ í¬ê¸° ì„¤ì •       |
| `-XX:+UseG1GC`               | GC ì•Œê³ ë¦¬ì¦˜ ì„¤ì •     |
| `-XX:MaxGCPauseMillis=200`   | G1 GC ëª©í‘œ ì§€ì—° ì‹œê°„ |
| `-XX:+PrintGCDetails`        | GC ìƒì„¸ ë¡œê·¸ ì¶œë ¥    |
| `-Xlog:gc*:file=gc.log:time` | Java 9+ GC ë¡œê·¸ ì„¤ì • |

------

### 3. í”„ë¡œíŒŒì¼ë§ ê°œìš”

**í”„ë¡œíŒŒì¼ë§(Profiling)** ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ **ì‹¤í–‰ ì‹œ ì„±ëŠ¥ì„ ì •ë°€ ì¸¡ì •**í•˜ì—¬ ë³‘ëª©ì´ë‚˜ ë¦¬ì†ŒìŠ¤ ê³¼ë‹¤ ì‚¬ìš© ì§€ì ì„ íŒŒì•…í•˜ëŠ” ê³¼ì •ì´ë‹¤.

ì£¼ìš” ë¶„ì„ ëŒ€ìƒ:

- Heap ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
- GC ë¹ˆë„ ë° ì†Œìš” ì‹œê°„
- CPU ì‚¬ìš©ë¥ 
- ìŠ¤ë ˆë“œ ìˆ˜, ìƒíƒœ
- ë©”ì„œë“œ í˜¸ì¶œ íšŸìˆ˜/ì‹œê°„
- OutOfMemoryError, Deadlock ë°œìƒ ì—¬ë¶€

------

### 4. ë„êµ¬ â‘ : jVisualVM

#### ê°œìš”

- JDKì— ê¸°ë³¸ í¬í•¨ (`jdk/bin/jvisualvm`)
- GUI ê¸°ë°˜ í†µí•© í”„ë¡œíŒŒì¼ëŸ¬ + ëª¨ë‹ˆí„°ë§ ë„êµ¬
- ì›ê²© JVM ì—°ê²° ê°€ëŠ¥ (JMX)

#### ê¸°ëŠ¥ ìš”ì•½

| í•­ëª©               | ì„¤ëª…                                             |
| ------------------ | ------------------------------------------------ |
| CPU í”„ë¡œíŒŒì¼ë§     | ë©”ì„œë“œ ë‹¨ìœ„ ì‹¤í–‰ ì‹œê°„ ë¶„ì„                       |
| Memory í”„ë¡œíŒŒì¼ë§  | í´ë˜ìŠ¤ë³„ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜, ë©”ëª¨ë¦¬ ì†Œë¹„ëŸ‰ ì¶”ì          |
| GC ëª¨ë‹ˆí„°ë§        | ìˆ˜ì§‘ ë¹ˆë„, GC ì‹œê°„ ì¶”ì                           |
| Heap Dump ë³´ê¸°     | ì‹¤ì‹œê°„ or íŒŒì¼ ê¸°ë°˜ ë¶„ì„ ê°€ëŠ¥                    |
| Thread ìƒíƒœ ì‹œê°í™” | ìŠ¤ë ˆë“œ ìˆ˜, ìƒíƒœ, Deadlock í‘œì‹œ                   |
| Plugin             | Visual GC, MBeans ë¸Œë¼ìš°ì €, Sampler ë“± ì¶”ê°€ ê°€ëŠ¥ |

#### ì‚¬ìš©ë²•

```
jvisualvm
```

- ì¢Œì¸¡ íŠ¸ë¦¬ â†’ JVM ì„ íƒ â†’ [Monitor], [Threads], [Sampler] íƒ­ ì„ íƒ
- ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ì €ì¥: `Heap Dump`

------

### 5. ë„êµ¬ â‘¡: jConsole

#### ê°œìš”

- JMX(Java Management Extensions) ê¸°ë°˜ ëª¨ë‹ˆí„°ë§ ë„êµ¬
- GUI ê°„ë‹¨í•˜ê³  ê°€ë³ì§€ë§Œ ì‹¤ì‹œê°„ ë¶„ì„ì— íŠ¹í™”

#### ì£¼ìš” ê¸°ëŠ¥

| í•­ëª©            | ì„¤ëª…                                 |
| --------------- | ------------------------------------ |
| ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ | Eden, Survivor, Old ë³„ ì‚¬ìš©ëŸ‰ ì‹œê°í™” |
| CPU ì‚¬ìš©ë¥       | JVM CPU ì ìœ ìœ¨ í™•ì¸                  |
| GC ëª¨ë‹ˆí„°ë§     | Minor, Full GC ë°œìƒ ì¶”ì              |
| ìŠ¤ë ˆë“œ ìˆ˜       | Runnable, Blocked ë“± ìƒíƒœ ë¶„ë¥˜       |
| MBeans ë¸Œë¼ìš°ì € | JMX MBean ì†ì„± ì ‘ê·¼/ì¡°ì‘ ê°€ëŠ¥        |

```
jconsole
```

> ë¡œì»¬ JVM ë˜ëŠ” `-Dcom.sun.management.jmxremote`ë¡œ ì›ê²© ì—°ê²° ê°€ëŠ¥

------

### 6. ë„êµ¬ â‘¢: Java Flight Recorder (JFR)

#### ê°œìš”

- ê³ ê¸‰ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ëŸ¬, **ë‚®ì€ ì˜¤ë²„í—¤ë“œ**ë¡œ ì¥ì‹œê°„ ì¶”ì  ê°€ëŠ¥
- Java 11 ì´ìƒ ê¸°ë³¸ ë‚´ì¥ (`jdk.jfr`)
- ê¸°ë¡ íŒŒì¼ì€ `.jfr` í™•ì¥ì

#### íŠ¹ì§•

| í•­ëª©             | ì„¤ëª…                                       |
| ---------------- | ------------------------------------------ |
| ì˜¤ë²„í—¤ë“œ ë‚®ìŒ    | ì‹¤ì‹œê°„ ìš´ì˜ í™˜ê²½ì—ì„œ ì‚¬ìš© ê°€ëŠ¥             |
| ì´ë²¤íŠ¸ ê¸°ë°˜ ê¸°ë¡ | GC, ìŠ¤ë ˆë“œ, Lock, IO, ë©”ì„œë“œ í˜¸ì¶œ, í• ë‹¹ ë“± |
| ë¹„ì£¼ì–¼ ë¶„ì„ ë„êµ¬ | Java Mission Control (JMC) í•„ìš”            |

#### ì‚¬ìš©ë²•

```
# ëª…ë ¹ì–´ ê¸°ë°˜ ìˆ˜ì§‘
java -XX:StartFlightRecording=filename=app.jfr,duration=60s -jar MyApp.jar
```

#### Java Mission Control (JMC)

- `.jfr` íŒŒì¼ì„ ë¶„ì„í•  ìˆ˜ ìˆëŠ” GUI ë„êµ¬
- ì£¼ìš” ë¶„ì„ í•­ëª©:
  - GC ì´ë²¤íŠ¸
  - Lock ê²½í•©
  - ìŠ¤ë ˆë“œ í™œë™
  - í´ë˜ìŠ¤ ë¡œë”©/ì–¸ë¡œë”©
  - ë©”ì„œë“œ Hotspot ë¶„ì„

------

### 7. ì‹¤ë¬´ ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

#### ì‹œë‚˜ë¦¬ì˜¤ 1: GC ê³¼ë‹¤

- GC ë¡œê·¸ ë¶„ì„ (`PrintGCDetails`)
- G1 GC + `MaxGCPauseMillis` ì¡°ì •
- Heap í¬ê¸° ì¡°ì • (`Xmx`, `Xms`)

#### ì‹œë‚˜ë¦¬ì˜¤ 2: OOM ë°œìƒ

- `Heap Dump` ìƒì„± í›„ `jvisualvm`ìœ¼ë¡œ ë¶„ì„
- ê°ì²´ ìˆ˜ê°€ ê³„ì† ì¦ê°€í•˜ëŠ” í´ë˜ìŠ¤ ì¶”ì 
- `WeakReference`, ìºì‹œ ë©”ì»¤ë‹ˆì¦˜ í™•ì¸

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ìŠ¤ë ˆë“œ ì¦ê°€/Deadlock

- `jstack`ìœ¼ë¡œ ìŠ¤ë ˆë“œ ìƒíƒœ ë¤í”„
- `jvisualvm`, `jconsole`ì—ì„œ Thread íƒ­ ë¶„ì„
- synchronized ë¸”ë¡ ê²½í•© ì—¬ë¶€ í™•ì¸

------

### 8. ê¸°íƒ€ ìœ ìš©í•œ íˆ´

| ë„êµ¬                                           | ì„¤ëª…                                   |
| ---------------------------------------------- | -------------------------------------- |
| `jmap -dump:live,format=b,file=heap.bin <pid>` | Heap Dump ì €ì¥                         |
| `jstack <pid>`                                 | ìŠ¤ë ˆë“œ ìŠ¤íƒ ë¤í”„                       |
| `jstat -gc <pid>`                              | GC ì‚¬ìš©ë¥  ì‹¤ì‹œê°„ ë¶„ì„                  |
| `async-profiler`                               | ë„¤ì´í‹°ë¸Œ + ìë°” í†µí•© CPU/ë©”ëª¨ë¦¬ ë¶„ì„ê¸° |
| `VisualVM Plugins`                             | Visual GC, Profiler ë“± í™•ì¥ ê°€ëŠ¥       |

------

### 9. JVM ì„±ëŠ¥ íŠœë‹ ì „ëµ ìš”ì•½

| ëŒ€ìƒ         | ì¡°ì • ìš”ì†Œ                                |
| ------------ | ---------------------------------------- |
| GC ì‹œê°„      | GC ì¢…ë¥˜ ì„ íƒ (G1/ZGC), Heap í¬ê¸°         |
| OOM          | ê°ì²´ ìˆ˜ëª… ê´€ë¦¬, ìºì‹œ/ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ì ê²€    |
| ì‘ë‹µ ì§€ì—°    | `-XX:MaxGCPauseMillis`, Thread/Lock ë¶„ì„ |
| CPU ê³¼ë‹¤     | JFR/Profilerë¡œ Hot Method ì¶”ì            |
| GC ë¡œê·¸ ë¶„ì„ | GCViewer, GCEasy, jClarity ì‚¬ìš© ê°€ëŠ¥     |

------

### 10. JVM í”„ë¡œíŒŒì¼ë§ + íŠœë‹ í†µí•© íë¦„

```
[ JVM ì‹¤í–‰ ]
   â†“
[ GC ë¡œê·¸, JFR, Heap Dump ]
   â†“
[ ë„êµ¬: jvisualvm, jconsole, JMC ]
   â†“
[ ë³‘ëª© ì›ì¸ ë¶„ì„ ]
   â†“
[ JVM ì˜µì…˜ ìˆ˜ì • + ì½”ë“œ ê°œì„  ]
```