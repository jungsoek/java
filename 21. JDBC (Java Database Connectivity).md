# 21. JDBC (Java Database Connectivity)

## ë“œë¼ì´ë²„ ë¡œë”©ê³¼ ì—°ê²°

Javaì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í•˜ë ¤ë©´ JDBC(Java Database Connectivity)ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. JDBCëŠ” ìë°” í”„ë¡œê·¸ë¨ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” **API** ì§‘í•©ì´ê³ , ê·¸ ì²« ë²ˆì§¸ ë‹¨ê³„ê°€ ë°”ë¡œ **ë“œë¼ì´ë²„ ë¡œë”©ê³¼ ì—°ê²°(connection)** ë‹¨ê³„ì´ë‹¤. ì•„ë˜ì— ê·¸ ê³¼ì •ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.

### âœ… 1. JDBC ë“œë¼ì´ë²„ë€?

- DBMS(Oracle, MySQL, PostgreSQL ë“±)ë§ˆë‹¤ JDBC ë“œë¼ì´ë²„ê°€ í•„ìš”í•¨
- ë“œë¼ì´ë²„ëŠ” ìë°”ì™€ DB ì‚¬ì´ì—ì„œ **í†µì‹ ì„ ì¤‘ê°œ**í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ (.jar íŒŒì¼)
- ë³´í†µ ë‹¤ìŒ ê²½ë¡œì—ì„œ ì œê³µë¨:
  - MySQL: `mysql-connector-java`
  - PostgreSQL: `postgresql.jar`
  - Oracle: `ojdbc11.jar`

------

### âœ… 2. ë“œë¼ì´ë²„ ë¡œë”© ë°©ì‹

#### ğŸ“Œ ë°©ë²• 1: `Class.forName()` ì‚¬ìš© (ì „í†µì ì¸ ë°©ì‹)

```
Class.forName("com.mysql.cj.jdbc.Driver");
```

- JVMì´ í´ë˜ìŠ¤ ë¡œë”© ì‹œ ë“œë¼ì´ë²„ ë“±ë¡ (`DriverManager.registerDriver()` í˜¸ì¶œë¨)
- Java 6 ì´í›„ëŠ” ìƒëµ ê°€ëŠ¥ (ì„œë¹„ìŠ¤ í”„ë¡œë°”ì´ë” ë©”ì»¤ë‹ˆì¦˜ì´ ëŒ€ì‹  ì²˜ë¦¬)

------

#### ğŸ“Œ ë°©ë²• 2: ìë™ ë¡œë”© (Java 6 ì´ìƒ)

JDBC 4.0 ì´í›„ë¶€í„°ëŠ” ë“œë¼ì´ë²„ `.jar` íŒŒì¼ì— `META-INF/services/java.sql.Driver` íŒŒì¼ì´ ì¡´ì¬í•˜ë©´, JVMì´ ìë™ìœ¼ë¡œ ë“œë¼ì´ë²„ í´ë˜ìŠ¤ë¥¼ ë¡œë”©í•¨.

- ì¦‰, `Class.forName()` ìƒëµ ê°€ëŠ¥
- ë‹¨, ë“œë¼ì´ë²„ `.jar` íŒŒì¼ì´ **classpath** ë˜ëŠ” **ëª¨ë“ˆ ê²½ë¡œ**ì— í¬í•¨ë¼ì•¼ í•¨

------

### âœ… 3. ì—°ê²°(Connection) ì—´ê¸°

#### ğŸ“Œ `DriverManager.getConnection()` ì‚¬ìš©

```
String url = "jdbc:mysql://localhost:3306/mydb";
String user = "root";
String password = "1234";

Connection conn = DriverManager.getConnection(url, user, password);
```

- ì—°ê²° ì„±ê³µ ì‹œ `Connection` ê°ì²´ ë°˜í™˜
- DB URLì€ ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¦„:

| DBMS       | URL í˜•ì‹ ì˜ˆì‹œ                                   |
| ---------- | ----------------------------------------------- |
| MySQL      | `jdbc:mysql://host:port/dbname`                 |
| PostgreSQL | `jdbc:postgresql://host:port/dbname`            |
| Oracle     | `jdbc:oracle:thin:@host:port:sid` or `:service` |

------

### âœ… 4. ì—°ê²°ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°

- ë“œë¼ì´ë²„ `.jar`ê°€ ëˆ„ë½ëœ ê²½ìš° â†’ `ClassNotFoundException`
- DB ì ‘ê·¼ ë¶ˆê°€, URL ì˜¤íƒ€ â†’ `SQLException`
- ì¸ì¦ ì‹¤íŒ¨ â†’ `Access denied` ì˜¤ë¥˜

------

### âœ… 5. ì „ì²´ ì˜ˆì œ

```
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class DBConnectExample {
    public static void main(String[] args) {
        String url = "jdbc:mysql://localhost:3306/mydb";
        String user = "root";
        String password = "1234";

        try {
            // Class.forName("com.mysql.cj.jdbc.Driver"); // ìƒëµ ê°€ëŠ¥ (JDBC 4.0 ì´ìƒ)
            Connection conn = DriverManager.getConnection(url, user, password);
            System.out.println("âœ… ì—°ê²° ì„±ê³µ!");
            conn.close();
        } catch (SQLException e) {
            System.out.println("âŒ ì—°ê²° ì‹¤íŒ¨: " + e.getMessage());
        }
    }
}
```

------

### âœ… 6. ì—°ê²° í›„ í•´ì•¼ í•  ì¼

1. **Statement/PreparedStatement** ìƒì„±
2. **SQL ì‹¤í–‰**
3. **ResultSet ì²˜ë¦¬**
4. **ìì› í•´ì œ (`close()`)**

â†’ ì´ ë¶€ë¶„ì€ ì´í›„ ë‹¨ê³„ì¸ `SQL ì‹¤í–‰`, `ResultSet ì²˜ë¦¬`, `íŠ¸ëœì­ì…˜ ê´€ë¦¬`ì—ì„œ ìì„¸íˆ ì„¤ëª…í• ê²Œ.

## SQL ì‹¤í–‰ (`Statement`, `PreparedStatement`)

Javaì—ì„œ SQLì„ ì‹¤í–‰í•˜ë ¤ë©´ `Statement` ë˜ëŠ” `PreparedStatement` ê°ì²´ë¥¼ ì‚¬ìš©í•œë‹¤.
 ì´ ë‘ ê°€ì§€ëŠ” JDBCì—ì„œ **SQL ëª…ë ¹ì–´ë¥¼ DBë¡œ ì „ì†¡í•˜ê³  ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ëŠ” í•µì‹¬ ë„êµ¬**ì´ë‹¤. 

### âœ… 1. `Statement`

#### ê°œìš”

- SQLì„ ë¬¸ìì—´ë¡œ ì‘ì„±í•´ì„œ ì‹¤í–‰
- ë™ì ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆì§€ë§Œ, **ë³´ì•ˆìƒ ìœ„í—˜(SQL Injection)** ì¡´ì¬

#### ì˜ˆì‹œ

```
Statement stmt = conn.createStatement();
String sql = "SELECT * FROM users WHERE username = 'admin'";
ResultSet rs = stmt.executeQuery(sql);
```

#### ì£¼ìš” ë©”ì„œë“œ

| ë©”ì„œë“œ                      | ì„¤ëª…                                                   |
| --------------------------- | ------------------------------------------------------ |
| `executeQuery(String sql)`  | SELECT ë¬¸ ì‹¤í–‰, `ResultSet` ë°˜í™˜                       |
| `executeUpdate(String sql)` | INSERT, UPDATE, DELETE ì‹¤í–‰, ì˜í–¥ë°›ì€ í–‰ ìˆ˜ ë°˜í™˜       |
| `execute(String sql)`       | ëª¨ë“  SQL ì‹¤í–‰ ê°€ëŠ¥. ê²°ê³¼ê°€ `ResultSet`ì´ë©´ `true` ë°˜í™˜ |

------

### âœ… 2. `PreparedStatement`

#### ê°œìš”

- **ë¯¸ë¦¬ ì»´íŒŒì¼ëœ SQL í…œí”Œë¦¿ì„ ì‚¬ìš©**, íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ê°€ëŠ¥
- SQL Injection ë°©ì§€, ì„±ëŠ¥ ê°œì„ , ê°€ë…ì„± í–¥ìƒ

#### ë¬¸ë²•

```
String sql = "SELECT * FROM users WHERE username = ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1, "admin");
ResultSet rs = pstmt.executeQuery();
```

> `?`ëŠ” **1-based index**ë¡œ ë°”ì¸ë”©ë¨ (`setXXX(index, value)`)

------

#### ë‹¤ì–‘í•œ íƒ€ì… ë°”ì¸ë”©

| ë©”ì„œë“œ                        | ì„¤ëª…             |
| ----------------------------- | ---------------- |
| `setString(int, String)`      | ë¬¸ìì—´ ë°”ì¸ë”©    |
| `setInt(int, int)`            | ì •ìˆ˜ ë°”ì¸ë”©      |
| `setDouble(int, double)`      | ì‹¤ìˆ˜ ë°”ì¸ë”©      |
| `setDate(int, java.sql.Date)` | ë‚ ì§œ ë°”ì¸ë”©      |
| `setObject(int, Object)`      | ë²”ìš© íƒ€ì… ë°”ì¸ë”© |

------

### âœ… 3. ì˜ˆì œ: `INSERT`, `UPDATE`, `DELETE`

```
String sql = "INSERT INTO users (username, age) VALUES (?, ?)";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1, "alice");
pstmt.setInt(2, 25);

int affectedRows = pstmt.executeUpdate();
System.out.println("ğŸŸ¢ ì‚½ì…ëœ í–‰ ìˆ˜: " + affectedRows);
```

------

### âœ… 4. ì˜ˆì œ: SELECT + ê²°ê³¼ ì²˜ë¦¬

```
String sql = "SELECT * FROM users WHERE age > ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setInt(1, 18);

ResultSet rs = pstmt.executeQuery();
while (rs.next()) {
    int id = rs.getInt("id");
    String name = rs.getString("username");
    int age = rs.getInt("age");
    System.out.printf("ID: %d, ì´ë¦„: %s, ë‚˜ì´: %d\n", id, name, age);
}
```

------

### âœ… 5. Statement vs PreparedStatement ìš”ì•½ ë¹„êµ

| í•­ëª©               | `Statement`     | `PreparedStatement` |
| ------------------ | --------------- | ------------------- |
| SQL ì‘ì„± ë°©ì‹      | ë¬¸ìì—´ ì¡°í•©     | í…œí”Œë¦¿ + íŒŒë¼ë¯¸í„°   |
| SQL Injection ë°©ì§€ | âŒ ìœ„í—˜í•¨        | âœ… ì•ˆì „              |
| ì„±ëŠ¥               | ì¿¼ë¦¬ë§ˆë‹¤ ì»´íŒŒì¼ | ì¿¼ë¦¬ ì¬ì‚¬ìš© ê°€ëŠ¥    |
| ê°€ë…ì„±             | ë‚®ìŒ            | ë†’ìŒ                |
| ì¶”ì²œ ìš©ë„          | ë‹¨ìˆœ í…ŒìŠ¤íŠ¸     | ì‹¤ë¬´ ì „ë°˜ì— ì‚¬ìš©    |

------

### âœ… 6. ì°¸ê³ : íŠ¸ëœì­ì…˜ ì²˜ë¦¬ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ê¸°

```
conn.setAutoCommit(false);

try {
    PreparedStatement pstmt1 = conn.prepareStatement("INSERT INTO orders VALUES (?, ?)");
    pstmt1.setInt(1, 1);
    pstmt1.setString(2, "book");
    pstmt1.executeUpdate();

    PreparedStatement pstmt2 = conn.prepareStatement("UPDATE stock SET qty = qty - 1 WHERE item = ?");
    pstmt2.setString(1, "book");
    pstmt2.executeUpdate();

    conn.commit();
} catch (SQLException e) {
    conn.rollback();
}
```

## íŠ¸ëœì­ì…˜ ì²˜ë¦¬

Javaì—ì„œ **íŠ¸ëœì­ì…˜(Transaction)** ì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì¼ë ¨ì˜ ì‘ì—…ì´ **ëª¨ë‘ ì„±ê³µí•˜ê±°ë‚˜ ëª¨ë‘ ì‹¤íŒ¨í•´ì•¼ í•˜ëŠ” ì›ìì  ë‹¨ìœ„**ë¡œ ì²˜ë¦¬ë˜ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. JDBCì—ì„œ íŠ¸ëœì­ì…˜ì„ ë‹¤ë£° ë•ŒëŠ” `Connection` ê°ì²´ë¥¼ í†µí•´ ì œì–´í•˜ë©°, **ìë™ ì»¤ë°‹ì„ ë„ê³  ìˆ˜ë™ìœ¼ë¡œ commit/rollback**ì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤.

------

### âœ… 1. íŠ¸ëœì­ì…˜ ê¸°ë³¸ êµ¬ì¡°

```
Connection conn = DriverManager.getConnection(...);
conn.setAutoCommit(false); // ìë™ ì»¤ë°‹ í•´ì œ

try {
    // ì—¬ëŸ¬ SQL ì‘ì—… ìˆ˜í–‰
    PreparedStatement pstmt1 = conn.prepareStatement(...);
    pstmt1.executeUpdate();

    PreparedStatement pstmt2 = conn.prepareStatement(...);
    pstmt2.executeUpdate();

    conn.commit(); // ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí•˜ë©´ ì»¤ë°‹
} catch (SQLException e) {
    conn.rollback(); // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡¤ë°±
} finally {
    conn.close();
}
```

------

### âœ… 2. `setAutoCommit(false)` ì˜ë¯¸

- ê¸°ë³¸ì ìœ¼ë¡œ JDBCëŠ” `setAutoCommit(true)`ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ â†’ ì¿¼ë¦¬ ì‹¤í–‰ë§ˆë‹¤ ìë™ ì»¤ë°‹ë¨
- `false`ë¡œ ë°”ê¾¸ë©´ `commit()` í˜¸ì¶œ ì „ê¹Œì§€ëŠ” ì‹¤ì œë¡œ DBì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ
- **rollback()** í˜¸ì¶œ ì‹œ, ëª¨ë“  ë³€ê²½ ì‚¬í•­ì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼

------

### âœ… 3. ì˜ˆì œ: ì£¼ë¬¸ ì²˜ë¦¬ íŠ¸ëœì­ì…˜

```
String orderSQL = "INSERT INTO orders (user_id, product_id) VALUES (?, ?)";
String stockSQL = "UPDATE products SET stock = stock - 1 WHERE id = ?";

Connection conn = DriverManager.getConnection(url, user, password);
conn.setAutoCommit(false); // íŠ¸ëœì­ì…˜ ì‹œì‘

try {
    // ì£¼ë¬¸ ì¶”ê°€
    PreparedStatement orderStmt = conn.prepareStatement(orderSQL);
    orderStmt.setInt(1, 1);
    orderStmt.setInt(2, 101);
    orderStmt.executeUpdate();

    // ì¬ê³  ê°ì†Œ
    PreparedStatement stockStmt = conn.prepareStatement(stockSQL);
    stockStmt.setInt(1, 101);
    stockStmt.executeUpdate();

    conn.commit(); // ì„±ê³µ ì‹œ ì»¤ë°‹
    System.out.println("âœ… ì£¼ë¬¸ ì²˜ë¦¬ ì™„ë£Œ");
} catch (SQLException e) {
    conn.rollback(); // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
    System.out.println("âŒ ì£¼ë¬¸ ì‹¤íŒ¨, ë¡¤ë°± ì²˜ë¦¬ë¨");
} finally {
    conn.setAutoCommit(true); // ë‹¤ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
    conn.close();
}
```

------

### âœ… 4. ì˜ˆì™¸ ë°œìƒ ì‹œ ì£¼ì˜í•  ì 

- `SQLException`ë§Œ ì¡ì§€ ë§ê³ , ë„“ì€ ë²”ìœ„ì˜ ì˜ˆì™¸ë„ ê³ ë ¤í•˜ëŠ” ê²Œ ì¢‹ìŒ
- `conn.rollback()`ì€ ë°˜ë“œì‹œ `catch` ë¸”ë¡ì—ì„œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„í•´ì•¼ í•¨

------

### âœ… 5. savepoint (ì¤‘ê°„ ì§€ì  ì„¤ì •)

ì—¬ëŸ¬ ë‹¨ê³„ ì¤‘ ì¼ë¶€ë§Œ ë¡¤ë°±í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©

```
conn.setAutoCommit(false);
Savepoint savepoint1 = conn.setSavepoint();

try {
    // ì²« ì‘ì—…
    ...

    // ë‘ ë²ˆì§¸ ì‘ì—…
    Savepoint savepoint2 = conn.setSavepoint();

    // ì˜¤ë¥˜ ë°œìƒ
    conn.rollback(savepoint2); // savepoint2 ì´í›„ ì‘ì—…ë§Œ ì·¨ì†Œ

    conn.commit(); // ì •ìƒ ì²˜ë¦¬ëœ ê²ƒë§Œ ë°˜ì˜
} catch (SQLException e) {
    conn.rollback(); // ì „ì²´ ë¡¤ë°±
}
```

------

### âœ… 6. íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ëŒ€í‘œì ì¸ ì‘ì—…ë“¤

| ì‘ì—… ì¢…ë¥˜      | íŠ¸ëœì­ì…˜ í•„ìš” ì—¬ë¶€                    |
| -------------- | ------------------------------------- |
| ì‚¬ìš©ì ê°€ì…    | âœ… (íšŒì›ì •ë³´ + ì´ˆê¸° ì„¤ì • ë“±ë¡ ë“±)      |
| ìƒí’ˆ ì£¼ë¬¸      | âœ… (ì£¼ë¬¸ + ì¬ê³  ê°ì†Œ + ê²°ì œ ë‚´ì—­ ë“±ë¡) |
| ê²Œì‹œíŒ ê¸€ ì‚­ì œ | âœ… (ê¸€ + ëŒ“ê¸€ + ì²¨ë¶€íŒŒì¼ ì¼ê´„ ì‚­ì œ)    |

------

### âœ… 7. JDBC ì™¸ì˜ ê³ ê¸‰ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë„êµ¬

| ë„êµ¬                              | ì„¤ëª…                                    |
| --------------------------------- | --------------------------------------- |
| **Spring TransactionManager**     | ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ì§€ì› (`@Transactional`) |
| **JTA (Java Transaction API)**    | ë¶„ì‚° íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì§€ì›                 |
| **Connection Pool (HikariCP ë“±)** | íŠ¸ëœì­ì…˜ê³¼ ì»¤ë„¥ì…˜ì˜ íš¨ìœ¨ì  ê´€ë¦¬ ì§€ì›    |

















## ResultSet ì²˜ë¦¬

## DB ì»¤ë„¥ì…˜ í’€ (HikariCP ë“±)