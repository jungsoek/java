# 21. JDBC (Java Database Connectivity)

## 드라이버 로딩과 연결

Java에서 데이터베이스와 연결하려면 JDBC(Java Database Connectivity)를 사용해야 한다. JDBC는 자바 프로그램에서 데이터베이스에 접근할 수 있게 해주는 **API** 집합이고, 그 첫 번째 단계가 바로 **드라이버 로딩과 연결(connection)** 단계이다. 아래에 그 과정을 구체적으로 설명한다.

### ✅ 1. JDBC 드라이버란?

- DBMS(Oracle, MySQL, PostgreSQL 등)마다 JDBC 드라이버가 필요함
- 드라이버는 자바와 DB 사이에서 **통신을 중개**하는 라이브러리 (.jar 파일)
- 보통 다음 경로에서 제공됨:
  - MySQL: `mysql-connector-java`
  - PostgreSQL: `postgresql.jar`
  - Oracle: `ojdbc11.jar`

------

### ✅ 2. 드라이버 로딩 방식

#### 📌 방법 1: `Class.forName()` 사용 (전통적인 방식)

```
Class.forName("com.mysql.cj.jdbc.Driver");
```

- JVM이 클래스 로딩 시 드라이버 등록 (`DriverManager.registerDriver()` 호출됨)
- Java 6 이후는 생략 가능 (서비스 프로바이더 메커니즘이 대신 처리)

------

#### 📌 방법 2: 자동 로딩 (Java 6 이상)

JDBC 4.0 이후부터는 드라이버 `.jar` 파일에 `META-INF/services/java.sql.Driver` 파일이 존재하면, JVM이 자동으로 드라이버 클래스를 로딩함.

- 즉, `Class.forName()` 생략 가능
- 단, 드라이버 `.jar` 파일이 **classpath** 또는 **모듈 경로**에 포함돼야 함

------

### ✅ 3. 연결(Connection) 열기

#### 📌 `DriverManager.getConnection()` 사용

```
String url = "jdbc:mysql://localhost:3306/mydb";
String user = "root";
String password = "1234";

Connection conn = DriverManager.getConnection(url, user, password);
```

- 연결 성공 시 `Connection` 객체 반환
- DB URL은 다음 형식을 따름:

| DBMS       | URL 형식 예시                                   |
| ---------- | ----------------------------------------------- |
| MySQL      | `jdbc:mysql://host:port/dbname`                 |
| PostgreSQL | `jdbc:postgresql://host:port/dbname`            |
| Oracle     | `jdbc:oracle:thin:@host:port:sid` or `:service` |

------

### ✅ 4. 연결에 실패하는 경우

- 드라이버 `.jar`가 누락된 경우 → `ClassNotFoundException`
- DB 접근 불가, URL 오타 → `SQLException`
- 인증 실패 → `Access denied` 오류

------

### ✅ 5. 전체 예제

```
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class DBConnectExample {
    public static void main(String[] args) {
        String url = "jdbc:mysql://localhost:3306/mydb";
        String user = "root";
        String password = "1234";

        try {
            // Class.forName("com.mysql.cj.jdbc.Driver"); // 생략 가능 (JDBC 4.0 이상)
            Connection conn = DriverManager.getConnection(url, user, password);
            System.out.println("✅ 연결 성공!");
            conn.close();
        } catch (SQLException e) {
            System.out.println("❌ 연결 실패: " + e.getMessage());
        }
    }
}
```

------

### ✅ 6. 연결 후 해야 할 일

1. **Statement/PreparedStatement** 생성
2. **SQL 실행**
3. **ResultSet 처리**
4. **자원 해제 (`close()`)**

→ 이 부분은 이후 단계인 `SQL 실행`, `ResultSet 처리`, `트랜잭션 관리`에서 자세히 설명할게.

## SQL 실행 (`Statement`, `PreparedStatement`)

Java에서 SQL을 실행하려면 `Statement` 또는 `PreparedStatement` 객체를 사용한다.
 이 두 가지는 JDBC에서 **SQL 명령어를 DB로 전송하고 결과를 받아오는 핵심 도구**이다. 

### ✅ 1. `Statement`

#### 개요

- SQL을 문자열로 작성해서 실행
- 동적으로 쿼리를 생성할 수 있지만, **보안상 위험(SQL Injection)** 존재

#### 예시

```
Statement stmt = conn.createStatement();
String sql = "SELECT * FROM users WHERE username = 'admin'";
ResultSet rs = stmt.executeQuery(sql);
```

#### 주요 메서드

| 메서드                      | 설명                                                   |
| --------------------------- | ------------------------------------------------------ |
| `executeQuery(String sql)`  | SELECT 문 실행, `ResultSet` 반환                       |
| `executeUpdate(String sql)` | INSERT, UPDATE, DELETE 실행, 영향받은 행 수 반환       |
| `execute(String sql)`       | 모든 SQL 실행 가능. 결과가 `ResultSet`이면 `true` 반환 |

------

### ✅ 2. `PreparedStatement`

#### 개요

- **미리 컴파일된 SQL 템플릿을 사용**, 파라미터 바인딩 가능
- SQL Injection 방지, 성능 개선, 가독성 향상

#### 문법

```
String sql = "SELECT * FROM users WHERE username = ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1, "admin");
ResultSet rs = pstmt.executeQuery();
```

> `?`는 **1-based index**로 바인딩됨 (`setXXX(index, value)`)

------

#### 다양한 타입 바인딩

| 메서드                        | 설명             |
| ----------------------------- | ---------------- |
| `setString(int, String)`      | 문자열 바인딩    |
| `setInt(int, int)`            | 정수 바인딩      |
| `setDouble(int, double)`      | 실수 바인딩      |
| `setDate(int, java.sql.Date)` | 날짜 바인딩      |
| `setObject(int, Object)`      | 범용 타입 바인딩 |

------

### ✅ 3. 예제: `INSERT`, `UPDATE`, `DELETE`

```
String sql = "INSERT INTO users (username, age) VALUES (?, ?)";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1, "alice");
pstmt.setInt(2, 25);

int affectedRows = pstmt.executeUpdate();
System.out.println("🟢 삽입된 행 수: " + affectedRows);
```

------

### ✅ 4. 예제: SELECT + 결과 처리

```
String sql = "SELECT * FROM users WHERE age > ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setInt(1, 18);

ResultSet rs = pstmt.executeQuery();
while (rs.next()) {
    int id = rs.getInt("id");
    String name = rs.getString("username");
    int age = rs.getInt("age");
    System.out.printf("ID: %d, 이름: %s, 나이: %d\n", id, name, age);
}
```

------

### ✅ 5. Statement vs PreparedStatement 요약 비교

| 항목               | `Statement`     | `PreparedStatement` |
| ------------------ | --------------- | ------------------- |
| SQL 작성 방식      | 문자열 조합     | 템플릿 + 파라미터   |
| SQL Injection 방지 | ❌ 위험함        | ✅ 안전              |
| 성능               | 쿼리마다 컴파일 | 쿼리 재사용 가능    |
| 가독성             | 낮음            | 높음                |
| 추천 용도          | 단순 테스트     | 실무 전반에 사용    |

------

### ✅ 6. 참고: 트랜잭션 처리와 함께 사용하기

```
conn.setAutoCommit(false);

try {
    PreparedStatement pstmt1 = conn.prepareStatement("INSERT INTO orders VALUES (?, ?)");
    pstmt1.setInt(1, 1);
    pstmt1.setString(2, "book");
    pstmt1.executeUpdate();

    PreparedStatement pstmt2 = conn.prepareStatement("UPDATE stock SET qty = qty - 1 WHERE item = ?");
    pstmt2.setString(1, "book");
    pstmt2.executeUpdate();

    conn.commit();
} catch (SQLException e) {
    conn.rollback();
}
```

## 트랜잭션 처리

Java에서 **트랜잭션(Transaction)** 은 데이터베이스의 일련의 작업이 **모두 성공하거나 모두 실패해야 하는 원자적 단위**로 처리되는 것을 의미한다. JDBC에서 트랜잭션을 다룰 때는 `Connection` 객체를 통해 제어하며, **자동 커밋을 끄고 수동으로 commit/rollback**을 수행해야 한다.

------

### ✅ 1. 트랜잭션 기본 구조

```
Connection conn = DriverManager.getConnection(...);
conn.setAutoCommit(false); // 자동 커밋 해제

try {
    // 여러 SQL 작업 수행
    PreparedStatement pstmt1 = conn.prepareStatement(...);
    pstmt1.executeUpdate();

    PreparedStatement pstmt2 = conn.prepareStatement(...);
    pstmt2.executeUpdate();

    conn.commit(); // 모든 작업이 성공하면 커밋
} catch (SQLException e) {
    conn.rollback(); // 에러 발생 시 롤백
} finally {
    conn.close();
}
```

------

### ✅ 2. `setAutoCommit(false)` 의미

- 기본적으로 JDBC는 `setAutoCommit(true)`로 설정되어 있음 → 쿼리 실행마다 자동 커밋됨
- `false`로 바꾸면 `commit()` 호출 전까지는 실제로 DB에 반영되지 않음
- **rollback()** 호출 시, 모든 변경 사항을 원래대로 되돌림

------

### ✅ 3. 예제: 주문 처리 트랜잭션

```
String orderSQL = "INSERT INTO orders (user_id, product_id) VALUES (?, ?)";
String stockSQL = "UPDATE products SET stock = stock - 1 WHERE id = ?";

Connection conn = DriverManager.getConnection(url, user, password);
conn.setAutoCommit(false); // 트랜잭션 시작

try {
    // 주문 추가
    PreparedStatement orderStmt = conn.prepareStatement(orderSQL);
    orderStmt.setInt(1, 1);
    orderStmt.setInt(2, 101);
    orderStmt.executeUpdate();

    // 재고 감소
    PreparedStatement stockStmt = conn.prepareStatement(stockSQL);
    stockStmt.setInt(1, 101);
    stockStmt.executeUpdate();

    conn.commit(); // 성공 시 커밋
    System.out.println("✅ 주문 처리 완료");
} catch (SQLException e) {
    conn.rollback(); // 실패 시 롤백
    System.out.println("❌ 주문 실패, 롤백 처리됨");
} finally {
    conn.setAutoCommit(true); // 다시 기본값으로 복원
    conn.close();
}
```

------

### ✅ 4. 예외 발생 시 주의할 점

- `SQLException`만 잡지 말고, 넓은 범위의 예외도 고려하는 게 좋음
- `conn.rollback()`은 반드시 `catch` 블록에서 안전하게 호출할 수 있도록 설계해야 함

------

### ✅ 5. savepoint (중간 지점 설정)

여러 단계 중 일부만 롤백하고 싶을 때 사용

```
conn.setAutoCommit(false);
Savepoint savepoint1 = conn.setSavepoint();

try {
    // 첫 작업
    ...

    // 두 번째 작업
    Savepoint savepoint2 = conn.setSavepoint();

    // 오류 발생
    conn.rollback(savepoint2); // savepoint2 이후 작업만 취소

    conn.commit(); // 정상 처리된 것만 반영
} catch (SQLException e) {
    conn.rollback(); // 전체 롤백
}
```

------

### ✅ 6. 트랜잭션이 필요한 대표적인 작업들

| 작업 종류      | 트랜잭션 필요 여부                    |
| -------------- | ------------------------------------- |
| 사용자 가입    | ✅ (회원정보 + 초기 설정 등록 등)      |
| 상품 주문      | ✅ (주문 + 재고 감소 + 결제 내역 등록) |
| 게시판 글 삭제 | ✅ (글 + 댓글 + 첨부파일 일괄 삭제)    |

------

### ✅ 7. JDBC 외의 고급 트랜잭션 처리 도구

| 도구                              | 설명                                    |
| --------------------------------- | --------------------------------------- |
| **Spring TransactionManager**     | 선언적 트랜잭션 지원 (`@Transactional`) |
| **JTA (Java Transaction API)**    | 분산 트랜잭션 처리 지원                 |
| **Connection Pool (HikariCP 등)** | 트랜잭션과 커넥션의 효율적 관리 지원    |

















## ResultSet 처리

## DB 커넥션 풀 (HikariCP 등)